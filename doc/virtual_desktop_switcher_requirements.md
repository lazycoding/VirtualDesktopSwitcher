# 鼠标侧键滑动切换虚拟桌面应用需求说明

## 1. 产品概述
开发一个Windows后台应用，通过鼠标侧键滑动动作实现虚拟桌面切换功能。

## 2. 功能需求
### 2.1 核心功能
- 鼠标侧键监听
  - 识别鼠标侧键(XButton1/XButton2)按下
  - 检测滑动方向(左/右)
  
- 虚拟桌面控制
  - 切换到左侧桌面(滑动左)
  - 切换到右侧桌面(滑动右)
  - 获取当前桌面信息

### 2.2 配置功能
- 灵敏度设置
- 启用/禁用热键
- 开机自启动

## 3. 技术实现细节

### 3.1 鼠标事件监听技术方案
- **底层API选择**：
  - 使用Windows API的`SetWindowsHookEx`设置鼠标钩子
  - 监听`WM_XBUTTONDOWN`和`WM_XBUTTONUP`消息
  - 通过鼠标移动轨迹计算滑动方向
  
- **滑动检测算法**：
  - 侧键按下时记录初始鼠标位置
  - 实时跟踪鼠标移动距离
  - 滑动阈值：水平移动距离>50像素触发切换
  - 方向判断：左滑(X轴负方向)切换左桌面，右滑(X轴正方向)切换右桌面

### 3.2 虚拟桌面控制API
- **Windows COM接口**：
  - `IVirtualDesktopManager`接口管理虚拟桌面
  - `IVirtualDesktopManagerInternal`内部接口(需动态获取)
  - 使用`CoCreateInstance`创建COM对象
  
- **桌面切换逻辑**：
  - 获取当前桌面索引
  - 计算目标桌面位置
  - 调用`SwitchDesktop`方法切换

### 3.3 后台服务架构
- **系统托盘应用**：
  - 最小化到系统托盘区
  - 右键菜单提供配置选项
  - 实时状态显示(启用/禁用)

- **服务生命周期**：
  - 开机自启动注册表项
  - 异常崩溃自动重启机制
  - 优雅退出处理

## 4. 用户交互设计

### 4.1 配置界面设计
- **主设置窗口**：
  - 滑动灵敏度滑块(10-200像素)
  - 启用/禁用开关
  - 开机自启动选项
  
- **高级设置**：
  - 自定义侧键映射(XButton1/XButton2)
  - 滑动方向反转选项
  - 调试日志开关

### 4.2 视觉反馈机制
- **滑动轨迹显示**：
  - 半透明线条实时绘制鼠标移动路径
  - 线条颜色可配置(默认蓝色)
  - 线条粗细可调节(1-5px)
  - 自动渐隐消失效果

- **桌面切换动画**：
  - 屏幕边缘滑动提示
  - 桌面切换进度指示
  - 当前桌面编号显示

- **操作状态提示**：
  - 系统托盘图标颜色变化
  - 操作成功/失败提示音
  - 桌面切换计数显示

### 4.3 错误处理机制
- **异常情况处理**：
  - 虚拟桌面API调用失败重试
  - 鼠标钩子失效自动重建
  - 权限不足提示用户

- **用户通知**：
  - 友好的错误消息对话框
  - 操作日志记录
  - 问题诊断工具

## 5. 测试方案

### 5.1 兼容性测试矩阵
- **操作系统版本**：
  - Windows 10 (1909, 20H2, 21H1, 21H2)
  - Windows 11 (21H2, 22H2, 23H2)
  
- **硬件环境**：
  - 不同DPI设置的显示器
  - 多种品牌鼠标设备
  - 多显示器配置场景

### 5.2 性能测试标准
- **资源占用**：
  - 内存使用峰值<30MB
  - CPU占用率<1%(空闲状态)
  - 启动时间<3秒
  
- **响应性能**：
  - 滑动检测延迟<50ms
  - 桌面切换时间<200ms
  - 无界面卡顿现象

### 5.3 用户体验测试用例
- **功能测试**：
  - 侧键滑动准确识别
  - 滑动轨迹显示效果
  - 桌面切换方向正确
  - 配置保存和加载
  
- **边界测试**：
  - 快速连续滑动处理
  - 最小化状态功能正常
  - 系统休眠唤醒后恢复

## 6. 非功能需求
- 性能：占用内存<50MB
- 兼容性：Windows 10/11
- 可靠性：不干扰其他鼠标功能